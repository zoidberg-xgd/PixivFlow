services:
  pixivflow:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pixivflow
    restart: unless-stopped
    
    # 环境变量
    environment:
      - NODE_ENV=production
      - TZ=Asia/Shanghai
      # 跳过容器内自动登录（容器内无法进行交互式登录）
      - PIXIV_SKIP_AUTO_LOGIN=true
      # Docker 容器内路径配置
      - PIXIV_DATABASE_PATH=/app/data/pixiv-downloader.db
      - PIXIV_DOWNLOAD_DIR=/app/downloads
      - PIXIV_ILLUSTRATION_DIR=/app/downloads/downloads/illustrations
      - PIXIV_NOVEL_DIR=/app/downloads/downloads/novels
      # 代理设置（使用本机代理）
      # 注意：macOS 上的 Docker Desktop 不支持 host 网络模式
      # 如果代理只监听在 127.0.0.1，需要使用其他方法（如端口转发或让代理监听在 0.0.0.0）
      # 临时方案：使用配置文件中的代理设置
      # - HTTP_PROXY=http://127.0.0.1:6152
      # - HTTPS_PROXY=http://127.0.0.1:6152
      # 注意：undici ProxyAgent 可能不支持 SOCKS5，优先使用 HTTP/HTTPS 代理
      # 如果必须使用 SOCKS5，需要在配置文件中设置，而不是通过环境变量
      # - ALL_PROXY=socks5://host.docker.internal:6153
      # 如果代理在局域网其他机器，直接使用 IP 地址：
      # - HTTP_PROXY=http://192.168.1.100:7890
    
    # 数据持久化
    volumes:
      # 配置文件目录
      - ./config:/app/config
      # 数据目录（数据库和日志）
      - ./data:/app/data
      # 下载目录
      - ./downloads:/app/downloads
    
    # 网络配置
    # 注意：macOS 上的 Docker Desktop 不支持 host 网络模式
    # 如果代理只监听在 127.0.0.1，容器无法直接访问
    # 解决方案：在配置文件中启用代理配置，或让代理监听在 0.0.0.0
    network_mode: bridge
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    # 资源限制（可选）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M
    
    # 健康检查
    healthcheck:
      test: ["CMD", "node", "-e", "require('fs').existsSync('/app/data/pixiv-downloader.db') ? process.exit(0) : process.exit(1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # WebUI 服务（可选，如果需要 WebUI）
  pixivflow-webui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pixivflow-webui
    restart: unless-stopped
    command: node dist/webui/index.js
    
    environment:
      - NODE_ENV=production
      - TZ=Asia/Shanghai
      - PORT=3000
      - HOST=0.0.0.0
      - STATIC_PATH=/app/webui-frontend/dist
      # Docker 容器内路径配置
      - PIXIV_DATABASE_PATH=/app/data/pixiv-downloader.db
      - PIXIV_DOWNLOAD_DIR=/app/downloads
      - PIXIV_ILLUSTRATION_DIR=/app/downloads/downloads/illustrations
      - PIXIV_NOVEL_DIR=/app/downloads/downloads/novels
      # 代理设置（使用本机代理，同上）
      - HTTP_PROXY=http://127.0.0.1:6152
      - HTTPS_PROXY=http://127.0.0.1:6152
      # 注意：undici ProxyAgent 可能不支持 SOCKS5，优先使用 HTTP/HTTPS 代理
      # - ALL_PROXY=socks5://host.docker.internal:6153
    
    volumes:
      - ./config:/app/config
      - ./data:/app/data
      - ./downloads:/app/downloads
    
    # 网络配置（同主服务）
    network_mode: bridge
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    ports:
      - "3000:3000"
    
    depends_on:
      - pixivflow
    
    # 如果只需要 WebUI，可以注释掉上面的 pixivflow 服务

