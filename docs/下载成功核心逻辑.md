# 下载成功核心逻辑说明

## 📋 完整下载流程

### 1. 搜索阶段（PixivClient）

**位置**: `src/pixiv/PixivClient.ts`

- **OR关系搜索**：每个标签获取200个结果
- **合并去重**：合并所有标签的结果，基于作品ID去重
- **全局排序**：按热度（`popular_desc`）排序
- **日期过滤**：在排序后、应用limit前进行日期过滤
- **应用Limit**：取前N个结果

**关键代码**：
```typescript
// 每个标签搜索200个结果
const searchLimit = 200;
// 合并所有结果
const allResults = [...];
// 去重
const uniqueResults = deduplicate(allResults);
// 排序
const sortedResults = sortByPopularity(uniqueResults);
// 日期过滤
const filteredResults = filterByDate(sortedResults, startDate, endDate);
// 应用limit
return filteredResults.slice(0, limit);
```

### 2. 下载准备阶段（DownloadManager）

**位置**: `src/download/DownloadManager.ts` → `downloadItems()`

- **应用过滤器**：日期、收藏数等（`filterItems()`）
- **检查已下载**：批量检查数据库，跳过已下载的作品
- **准备下载队列**：按顺序或随机模式准备下载列表

### 3. 实际下载阶段（downloadNovel）

**位置**: `src/download/DownloadManager.ts` → `downloadNovel()`

#### 3.1 获取作品详情
```typescript
const { novel: detail, tags } = await this.client.getNovelDetailWithTags(novel.id);
const text = await this.client.getNovelText(novel.id);
```

#### 3.2 语言检测（如果启用）
```typescript
if (target.detectLanguage !== false) {
  const fullContent = `${detail.title}\n${text}`;
  detectedLang = detectLanguage(fullContent);
}
```

#### 3.3 语言过滤
```typescript
if (target.languageFilter && detectedLang) {
  const shouldDownload = 
    (target.languageFilter === 'chinese' && detectedLang.isChinese) ||
    (target.languageFilter === 'non-chinese' && !detectedLang.isChinese);
  
  if (!shouldDownload) {
    throw new Error(`Novel ${detail.id} skipped: language filter mismatch`);
  }
}
```

**重要**：语言过滤错误现在会被正确识别为可跳过错误，不会中断下载流程。

#### 3.4 保存文件
```typescript
// 生成文件内容（包含标题、作者、标签等元信息）
const content = `${header}\n${text}`;
const fileName = `${detail.id}_${detail.title}.txt`;

// 保存文本文件
const filePath = await this.fileService.saveText(content, fileName, metadata);

// 保存元数据JSON文件
await this.fileService.saveMetadata(filePath, pixivMetadata);

// 记录到数据库
this.database.insertDownload({
  pixivId: String(detail.id),
  type: 'novel',
  tag,
  title: detail.title,
  filePath,
  author: detail.user?.name,
  userId: detail.user?.id,
});
```

### 4. 错误处理

**位置**: `src/download/DownloadManager.ts` → `handleDownloadError()`

#### 可跳过的错误（不会中断下载）
- ✅ 404错误（作品已删除或私有）
- ✅ 403错误（访问被拒绝）
- ✅ 网络超时错误
- ✅ 连接错误（ECONNREFUSED, ENOTFOUND等）
- ✅ **语言过滤错误**（新修复）
- ✅ 明确标记为跳过的错误（"skipped:"）

#### 不可跳过的错误（会中断下载）
- ❌ 认证错误（需要重新登录）
- ❌ 配置错误
- ❌ 数据库错误

### 5. 下载成功判断

**位置**: `src/download/DownloadManager.ts` → `handleNovelTarget()`

```typescript
const { downloaded, skipped } = await this.downloadItems(novels, target, 'novel', downloadFn);

// 检查是否成功下载
if (downloaded === 0 && targetLimit > 0) {
  throw new Error(`Failed to download any novels`);
}

// 警告：下载数量明显不足
if (downloaded > 0 && downloaded < targetLimit * 0.5 && skippedCount > 0) {
  logger.warn(`Only downloaded ${downloaded} out of ${targetLimit} requested`);
}
```

## 🔍 下载成功的必要条件

### ✅ 必须满足的条件

1. **搜索成功**
   - 至少找到1个符合条件的小说
   - 日期过滤后仍有结果

2. **语言检测通过**（如果启用）
   - 语言检测成功识别语言
   - 符合`languageFilter`要求（如果设置）

3. **文件保存成功**
   - 文本文件成功写入磁盘
   - 元数据JSON文件成功保存
   - 数据库记录成功插入

4. **无致命错误**
   - 没有认证错误
   - 没有配置错误
   - 没有数据库错误

### ⚠️ 可能失败的原因

1. **搜索阶段**
   - 没有找到符合日期要求的小说
   - 所有结果都已被下载过
   - 网络请求失败

2. **语言过滤阶段**
   - 所有小说都不符合语言要求
   - 语言检测失败（文本太短）

3. **下载阶段**
   - 小说已被删除（404）
   - 小说设为私有（403）
   - 网络超时
   - 文件系统权限问题

## 📊 下载流程示例

### 你的配置示例

```json
{
  "tag": "大肚 丸吞 ...",
  "limit": 5,
  "startDate": "2025-11-08",
  "endDate": "2025-11-08",
  "languageFilter": "chinese",
  "detectLanguage": true
}
```

### 执行流程

1. **搜索**：使用AND关系搜索包含所有标签的作品
2. **排序**：按热度排序 → 最热门的在前
3. **日期过滤**：只保留2025-11-08的作品 → 假设剩余50个
4. **应用Limit**：取前5个 → 5个最热门的中文小说
5. **下载**：
   - 检查是否已下载 → 跳过已下载的
   - 获取详情和文本
   - 语言检测 → 如果不是中文，跳过
   - 保存文件 → 成功下载

### 日志输出示例

```
[INFO] Date filtering (2025-11-08 ~ 2025-11-08): 2000 -> 50 novels
[INFO] Processing novel tag 大肚 丸吞 ...
[INFO] Found 5 search results
[INFO] Detected language for novel 123456: Chinese (zh)
[INFO] Successfully downloaded novel 123456 (1/5)
[INFO] Detected language for novel 789012: Japanese (ja)
[INFO] Skipping novel 789012 due to language filter (detected: Japanese, filter: chinese)
[INFO] Successfully downloaded novel 345678 (2/5)
...
[INFO] 完成下载: 5 个 小说
```

## 🛠️ 故障排查

### 问题：下载数量为0

**可能原因**：
1. 日期范围内没有符合条件的小说
2. 所有小说都不符合语言要求
3. 所有小说都已被下载过
4. 网络问题导致搜索失败

**解决方法**：
1. 检查日期范围是否正确
2. 检查语言过滤是否过于严格
3. 查看日志中的错误信息
4. 尝试扩大搜索范围（增加limit或移除日期限制）

### 问题：下载数量少于预期

**可能原因**：
1. 部分小说不符合语言要求（被跳过）
2. 部分小说已被删除或设为私有（404/403）
3. 部分小说已下载过

**解决方法**：
1. 查看日志中的"skipped"信息
2. 检查数据库中的下载记录
3. 增加搜索limit以获取更多候选

### 问题：语言检测不准确

**可能原因**：
1. 文本太短，无法准确检测
2. 混合语言内容

**解决方法**：
1. 如果检测失败，默认会下载（避免误判）
2. 可以调整`detectLanguage`设置
3. 查看日志中的检测结果

## 📝 关键代码位置

- **搜索逻辑**: `src/pixiv/PixivClient.ts` → `searchNovels()`
- **下载管理**: `src/download/DownloadManager.ts` → `handleNovelTarget()`
- **实际下载**: `src/download/DownloadManager.ts` → `downloadNovel()`
- **错误处理**: `src/utils/errors.ts` → `isSkipableError()`
- **文件保存**: `src/download/FileService.ts` → `saveText()`

## ✅ 最新修复

1. **语言过滤错误识别**：现在语言过滤错误会被正确识别为可跳过错误，不会中断下载流程
2. **日期过滤优化**：在排序后、应用limit前进行日期过滤，确保最终结果符合日期要求

