name: Version Sync Check

on:
  push:
    tags:
      - 'v*'
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  schedule:
    # ÊØèÂ§© UTC Êó∂Èó¥ 00:00 ËøêË°å‰∏ÄÊ¨°Ê£ÄÊü•
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-version-sync:
    name: Check Version Synchronization
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ëé∑ÂèñÊâÄÊúâÊ†áÁ≠æÂíåÊèê‰∫§ÂéÜÂè≤
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Get package.json version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ package.json version: $VERSION"
      
      - name: Check npm version
        id: npm-check
        run: |
          VERSION="${{ steps.package-version.outputs.version }}"
          if npm view pixivflow@$VERSION version &>/dev/null; then
            NPM_VERSION=$(npm view pixivflow@$VERSION version)
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "version=$NPM_VERSION" >> $GITHUB_OUTPUT
            echo "‚úÖ Version $VERSION exists on npm"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Version $VERSION not found on npm"
          fi
      
      - name: Check GitHub tags
        id: github-tags
        run: |
          VERSION="${{ steps.package-version.outputs.version }}"
          TAG_NAME="v$VERSION"
          
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag $TAG_NAME exists"
            
            # È™åËØÅÊ†áÁ≠æÊåáÂêëÁöÑ package.json ÁâàÊú¨
            TAG_PACKAGE_VERSION=$(git show $TAG_NAME:package.json 2>/dev/null | grep '"version"' | head -1 | sed 's/.*"version": *"\([^"]*\)".*/\1/' || echo "")
            if [[ -n "$TAG_PACKAGE_VERSION" ]] && [[ "$TAG_PACKAGE_VERSION" != "$VERSION" ]]; then
              echo "inconsistent=true" >> $GITHUB_OUTPUT
              echo "‚ùå Tag $TAG_NAME points to package.json version $TAG_PACKAGE_VERSION (expected $VERSION)"
            else
              echo "inconsistent=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Tag $TAG_NAME not found"
          fi
      
      - name: Check for extra tags
        id: extra-tags
        run: |
          echo "Checking for extra tags (tags not on npm)..."
          EXTRA_TAGS=""
          RECENT_TAGS=$(git tag -l "v2.*" | sort -V | tail -5)
          
          for tag in $RECENT_TAGS; do
            tag_version="${tag#v}"
            if ! npm view pixivflow@$tag_version version &>/dev/null 2>&1; then
              EXTRA_TAGS="$EXTRA_TAGS $tag"
            fi
          done
          
          if [[ -n "$EXTRA_TAGS" ]]; then
            echo "extra_tags=$EXTRA_TAGS" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Found extra tags not on npm:$EXTRA_TAGS"
          else
            echo "extra_tags=" >> $GITHUB_OUTPUT
            echo "‚úÖ No extra tags found"
          fi
      
      - name: Report status
        run: |
          VERSION="${{ steps.package-version.outputs.version }}"
          TAG_EXISTS="${{ steps.github-tags.outputs.exists }}"
          TAG_INCONSISTENT="${{ steps.github-tags.outputs.inconsistent }}"
          EXTRA_TAGS="${{ steps.extra-tags.outputs.extra_tags }}"

          # Re-check npm with retry if tag exists (allow time for publish/indexing)
          NPM_EXISTS=false
          if npm view pixivflow@"$VERSION" version &>/dev/null; then
            NPM_EXISTS=true
          else
            if [[ "$TAG_EXISTS" == "true" ]]; then
              echo "Waiting for npm to publish/index version $VERSION..."
              for i in {1..20}; do  # up to ~5 minutes if 15s sleep
                sleep 15
                if npm view pixivflow@"$VERSION" version &>/dev/null; then
                  NPM_EXISTS=true
                  echo "npm version $VERSION detected after wait ($i attempts)"
                  break
                fi
              done
            fi
          fi

          echo "## üìä Version Sync Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Version:** `$VERSION`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "$NPM_EXISTS" == "true" ]]; then
            echo "| npm | ‚úÖ Published |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| npm | ‚ùå Not published |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$TAG_EXISTS" == "true" ]]; then
            if [[ "$TAG_INCONSISTENT" == "true" ]]; then
              echo "| GitHub Tag | ‚ö†Ô∏è  Inconsistent |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| GitHub Tag | ‚úÖ Exists |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| GitHub Tag | ‚ùå Missing |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "$EXTRA_TAGS" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ö†Ô∏è  Extra Tags Found" >> $GITHUB_STEP_SUMMARY
            echo "The following tags exist but are not published to npm:" >> $GITHUB_STEP_SUMMARY
            for tag in $EXTRA_TAGS; do
              echo "- \`$tag\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

          # Âà§Êñ≠ÊòØÂê¶Â§±Ë¥•
          FAILED=false
          if [[ "$NPM_EXISTS" != "true" ]] && [[ "$TAG_EXISTS" == "true" ]]; then
            FAILED=true
            echo "‚ùå Version $VERSION has a tag but is not published to npm (after wait)"
          fi

          if [[ "$TAG_INCONSISTENT" == "true" ]]; then
            FAILED=true
            echo "‚ùå Tag version is inconsistent with package.json"
          fi

          if [[ "$FAILED" == "true" ]]; then
            echo "::error::Version synchronization check failed"
            exit 1
          fi
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.package-version.outputs.version }}';
            const npmExists = '${{ steps.npm-check.outputs.exists }}' === 'true';
            const tagExists = '${{ steps.github-tags.outputs.exists }}' === 'true';
            
            let comment = `## üîç Version Sync Check\n\n`;
            comment += `**Current version:** \`${version}\`\n\n`;
            comment += `- npm: ${npmExists ? '‚úÖ' : '‚ùå'}\n`;
            comment += `- GitHub tag: ${tagExists ? '‚úÖ' : '‚ùå'}\n\n`;
            
            if (!npmExists || !tagExists) {
              comment += `‚ö†Ô∏è  Version synchronization issues detected. Please ensure version is synced before merging.`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

